(provide 'svn)

(eval-when-compile (require 'cl) (require 'tmp-buffer))
(require 'compile)


(defun svn-cat (&optional rev)
  "Perform an svn cat -r rev on the current buffer into a temporary buffer.
If a prefix arg is specified, ask for the revision.
When called interactively, the name of the temporary buffer will be displayed."
  (interactive "P")
  (let* ((fname (file-name-nondirectory (buffer-file-name)))
	 (buf (tmp-buffer-create fname nil 'timeout 'svn))
	 (catname fname))

    (when rev
      (when (interactive-p)
	(setq rev (read-from-minibuffer "Revision: ")))
      (setq catname (concat catname "@" rev)))

    (save-current-buffer
      (set-buffer buf)
      (erase-buffer)
      (call-process "svn" nil buf nil "cat" catname)
      (set-buffer-modified-p nil)
      (when (interactive-p) (message "svn cat to buffer %s" (buffer-name))))

    buf))


;;;###autoload
(defun svn-diff (rev)
  "Perform an svn diff against the current buffer using ediff.
With a prefix arg, ask for the revision(s)."
  (interactive "P")
  (if (and (interactive-p) rev)
      (progn
	(setq rev (read-from-minibuffer "Revision: "))
	(if (string-match "\\([0-9]+\\):\\([0-9]+\\)" rev)
	    (ediff-buffers (svn-cat (match-string 2 rev))
			   (svn-cat (match-string 1 rev)))
	  (ediff-buffers (current-buffer) (svn-cat rev))))
    (ediff-buffers (current-buffer) (svn-cat))))


;;;###autoload
(defalias 'svn-ediff 'svn-diff)


;;;###autoload
(defun svn-tmp-cleanup ()
  "Cleanup all the tmp buffers created by the svn-* commands."
  (interactive)
  (tmp-buffer-reap 'svn))


(defun svn-cmd (cmd)
  (let* ((fname (file-name-nondirectory (buffer-file-name)))
	 (buff (get-buffer-create "*svn output*"))
	 (outwin (display-buffer buff)))
    (compilation-set-window-height outwin)
    (call-process "svn" nil buff t cmd fname)
    (revert-buffer nil t t)))


;;;###autoload
(defun svn-revert ()
  "Perform an svn revert on the current buffer."
  (interactive)
  (svn-cmd "revert"))

;;;###autoload
(defun svn-up ()
  "Perform an svn up on the current buffer."
  (interactive)
  (svn-cmd "up"))

;;;###autoload
(defun svn-url ()
  "Perform an svn info on the current buffer to get the svn url.
Output will be nil if this directory not in svn."
  (interactive)
  ;; Note: we must save dir before the set-buffer
  (let (url (dir default-directory))
    (save-current-buffer
      (set-buffer (get-buffer-create "*svn output*"))
      (erase-buffer)
      (call-process "svn" nil t nil "info" dir)
      (goto-char (point-min))
      (when (re-search-forward "^URL: \\(.+\\)" nil t)
	(setq url (concat (match-string 1) "/")))
      (when (interactive-p) (message "URL: %S" url))
      url)))
