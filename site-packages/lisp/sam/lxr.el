;;; lxr.el --- XEmacs interface to lxr source browser

;; Copyright (C) 2000,2001 Sean MacLennan
;; Revision:   1.3
;; XEmacs/Emacs

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation; either version 2, or (at your option)
;; any later version.

;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.

;; You should have received a copy of the GNU General Public License
;; along with GNU Emacs; see the file COPYING.  If not, write to the
;; Free Software Foundation, Inc., 59 Temple Place - Suite 330,
;; Boston, MA 02111-1307, USA.

;; For Linux Kernel
;; (setq lxr-url "http://lxr.linux.no"
;;       lxr-version "2.4.0"
;;       lxr-base (file-truename "/usr/src/linux")

(defvar lxr-url nil
  "*URL to use for lxr")

(defvar lxr-version nil
  "*Version string for lxr or nil for default")

(defvar lxr-arch nil
  "*Architecture for lxr or nil for default.
You should never need to set this....")

(defvar lxr-base nil
  "*Base for lxr files")

(defvar lxr-keymap nil
  "Keymap for lxr buffer.")

;; SAM This forces lxr to be single threaded
(defvar lxr-local-base nil "Local variable")

;; SAM DBG
(defvar lxr-start nil)
(defvar lxr-got nil)
(defvar lxr-done nil)
;; SAM


;;;###autoload
(defun lxr-at-point ()
  (interactive)
  (lxr (if (region-exists-p)
	   (buffer-substring (region-beginning) (region-end))
	 (current-word))))

;;;###autoload
(defun lxr (ident)
  (interactive "sIdentifier: ")
  (unless lxr-url (setq lxr-url (read-string "lxr url: ")))
  (unless lxr-base (setq lxr-base (read-string "lxr base: ")))
  (unless lxr-keymap
    (setq lxr-keymap (make-sparse-keymap "lxr"))
    (if (boundp 'running-xemacs)
	(progn
	  (define-key lxr-keymap 'button1 'lxr-mousable)
	  (define-key lxr-keymap 'button2 'lxr-mousable))
      (define-key lxr-keymap [(mouse-1)] 'lxr-mousable)
      (define-key lxr-keymap [(mouse-2)] 'lxr-mousable))
    (define-key lxr-keymap "g" 'lxr-mousable))
  (setq lxr-start (current-time)) ;; SAM DBG
  (let ((url (concat lxr-url "/ident?"
		     (if lxr-version (concat "v=" lxr-version ";"))
		     (if lxr-arch (concat "a=" lxr-arch ";"))
		     "i=" ident)))
    (http-get-page url "*lxr*" 'lxr-get-sentinel))
  (pop-to-buffer "*lxr*"))

(defun lxr-get-sentinel (proc str)
  ;; First make sure the http command succeeded
  (setq lxr-got (current-time)) ;; SAM DBG
  (let ((buffer (process-buffer proc)))
    (set-buffer buffer)
    (goto-char (point-min))
    (unless (looking-at "HTTP/[1-9]\\.[0-9]+ 200")
      ;; http error
      (error "http request failed: %s"
	     (buffer-substring (point-min) (progn (end-of-line) (point)))))

    ;; stip the server header
    (if (search-forward-regexp "^[ \t\r]*\n" nil t)
	(delete-region (point-min) (point)))

    (setq lxr-local-base lxr-base) ;; in case it is buffer local

    ;; Convert the page to text
    (set-buffer-modified-p nil)
    (html-to-text buffer lxr-keymap)
    (set-buffer-modified-p nil)
    )
  (setq lxr-done (current-time))
  (message "Start %s got %s done %s"
	   (current-time-string lxr-start)
	   (current-time-string lxr-got)
	   (current-time-string lxr-done))
  (message "Done"))

;; This is called on a mouse click
(defun lxr-mousable (event)
  (interactive "e")
  (let* ((extent (extent-at (event-point event)
			    ;; SAM (event-buffer event)
			    ))
	 (anchor (extent-property extent 'anchor))
	 line file)
    (cond
     ;; source file
     ((string-match "^source/\\([^#]+\\)#L\\([0-9]+\\)" anchor)
      (setq line (string-to-number (match-string 2 anchor)))
      (setq file (concat lxr-local-base (match-string 1 anchor)))
      (find-file file)
      (goto-char 0)
      (forward-line (1- line)))

     ;; ident (e.g. class reference)
     ((string-match "^ident" anchor)
      (http-get-page (concat lxr-url "/" anchor) "*lxr*" 'lxr-get-sentinel)
      (pop-to-buffer "*lxr*"))

     ;; generic http (e.g. lxr reference in trailer)
     ((string-match "^http:.*" anchor)
      (browse-url (match-string 0 anchor)))

     ;; huh?
     (t (error "Unknown anchor '%S'" anchor)))
    ))

(unless (boundp 'running-xemacs) (require 'extent))
(require 'http)
(require 'h2t)
(provide 'lxr)
