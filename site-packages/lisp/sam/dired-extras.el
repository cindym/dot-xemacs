;;; dired-extras.el --- Additions to dired

;; Copyright (C) 1997-2000 Sean MacLennan
;; Revision:   1.0

;; This program is free software; you can redistribute it and/or modify
;; it under the terms of the GNU General Public License as published by
;; the Free Software Foundation; either version 2, or (at your option)
;; any later version.

;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU General Public License for more details.

;; You should have received a copy of the GNU General Public License
;; along with GNU Emacs; see the file COPYING.  If not, write to the
;; Free Software Foundation, Inc., 59 Temple Place - Suite 330,
;; Boston, MA 02111-1307, USA.

;; To install: (add-hook 'dired-load-hook 'dired-extras-init)
;; Note: Putting a (require 'dired) here really slows things down

(defvar dired-du-command "du" "*`du' command.")
(defvar dired-du-args    "-s" "*Arguments to du.")

;;;###autoload
(defun dired-extras-init ()
  (define-key dired-mode-map "\C-cu" 'dired-do-du)
  (define-key dired-mode-map "\C-ca" 'dired-toggle-all)

  ;; This really isn't dired, but that is where I use it
  (and (not (assoc "\\.pdf$" auto-mode-alist))
       (exec-installed-p "acroread")
       (setq auto-mode-alist
	     (cons '("\\.pdf$" . do-acroread) auto-mode-alist))))

;;;###autoload
(defun dired-do-du ()
  "Call `du -s' on the current directory or file."
  (interactive)
  (let ((dir (dired-get-filename))
	(buf (generate-new-buffer "du")))
    (call-process dired-du-command nil buf nil dired-du-args dir)
    (message "%s" (buffer-substring nil nil buf))
    (kill-buffer buf)))

;;;###autoload
(defun dired-toggle-all (force)
  "Toggle showing dot-files."
  (interactive "P")
  (dired-sort-other
   (if (or force (member ?a dired-internal-switches))
       (delq ?a dired-internal-switches)
     (cons ?a dired-internal-switches))))

;;;###autoload
(defun do-acroread ()
  (when (not (null buffer-file-name))
    (start-process "acroread" nil "acroread" buffer-file-name)))

;;;###autoload
(defun dired-do-apply-function (func)
  "Apply an interactive lisp function to all the marked files.
The function is not passed any arguments. The function honours restrictions."
  (interactive "aFunction: ")
  (save-excursion
    (dolist (file (dired-get-marked-files))
      (message "Processing %s..." file)
      (set-buffer (find-file-noselect file))
      (goto-char (point-min))
      (apply func nil))
    (message "Done.")))

;; The following is not mine but from an email to xemacs-beta
;; From: samuel padgett <res00ajf@gte.net>
;; Sender: owner-xemacs-beta@xemacs.org
;; To: xemacs-beta@xemacs.org
;; Subject: reusing dired buffer
;; Date: Thu, 29 Jun 2000 01:34:58 -0400
;;
;; <snip>
;; I would really like to have the new directory contents replace the old
;; in a dired buffer.  If my cursor is positioned over a file, however, I
;; want dired to do the normal thing: open the file in a new buffer.
;; This seems to me like the most intuitive behavior.  I hacked out some
;; lisp code that does this:

;;###autoload
(defun dired-follow-file ()
  "In dired, visit the file or directory on this line.
If a directory is on the current line, replace the current
dired buffer with one containing the contents of the directory.
Otherwise, invoke `dired-find-file' on the file."
  (interactive)
  (let ((filename (dired-get-filename)))
    ;; if the file is a directory, replace the buffer with the
    ;;  directory's contents
    (if (file-directory-p filename)
        (find-alternate-file filename)
      ;; otherwise simply perform a normal `dired-find-file'
      (dired-find-file))))

(add-hook
 'dired-mode-hook
 (lambda ()
   (local-set-key "\C-m" 'dired-follow-file)
   (local-set-key "e" 'dired-follow-file)
   (local-set-key "f" 'dired-follow-file)))


;; End of email

(provide 'dired-extras)
