(provide 'git-diff)
(eval-when-compile (require 'cl))


(defvar git-tmp-buf-list nil "List of tmp buffers created.")


(defun git-tmp-buf (fname rev)
  "Create a unique tmp buffer."
  (let ((base (file-name-sans-extension fname))
	(ext (file-name-extension fname))
	bufname buf)
    (setq bufname (concat base "_" rev (if ext ".") ext)) ;; try simple case first
    (when (and (get-buffer bufname)
	       (not (member bufname git-tmp-buf-list)))
      (do ((count 1 (1+ count))) ((not (get-buffer bufname)) t)
	(setq bufname (concat base "_" rev "-" (number-to-string count) 
			      (if ext ".") ext))))
    (setq git-tmp-buf-list (add-to-list 'git-tmp-buf-list bufname))
    (setq buf (get-buffer-create bufname))
    buf))

(defun git-fname (path)
  "Given a full file path, return the path relative to the .git directory."
  (let (git-fname)
    (catch 'found
      (while t
	(unless (string-match "\\(.*\\)/\\([^/]+\\)$" path)
	  (error "No git base found"))
	(if git-fname
	    (setq git-fname (concat (match-string 2 path) "/" git-fname))
	  (setq git-fname (match-string 2 path)))
	(setq path (match-string 1 path))
	(when (file-exists-p (concat path "/.git"))
	  (throw 'found git-fname))))))

(defun git-cat (&optional rev)
  "Perform a git cat on the current buffer into a temporary buffer.
If a prefix arg is specified, ask for the revision. Default is HEAD.
When called interactively, the name of the temporary buffer will be displayed."
  (interactive "P")
  (if rev
      (when (interactive-p)
	(setq rev (read-from-minibuffer "Revision: "))))
  (let* ((full-path (buffer-file-name))
	 (git-fname (git-fname full-path))
	 (fname (file-name-nondirectory full-path))
	 (buf (git-tmp-buf fname rev))
	 (catname (concat rev ":" git-fname)))
    (save-current-buffer
      (set-buffer buf) ;; really for GNU Emacs
      (erase-buffer)
      (call-process "git" nil buf nil "show" catname)
      (set-buffer-modified-p nil)
      (when (interactive-p)
	(message "git cat to buffer %s" (buffer-name buf))))
    buf))

;;;###autoload
(defun git-diff (rev)
  "Perform a git diff against the current buffer using ediff.
With a prefix arg, ask for the revision. Otherwise defaults to HEAD."
  (interactive "P")
  (when (and (interactive-p) rev)
    (setq rev (read-from-minibuffer "Revision: ")))
  (let ((buf (git-cat rev)))
    (ediff-buffers (current-buffer) buf)))

;;;###autoload
(defalias 'git-ediff 'git-diff)

;;;###autoload
(defun git-tmp-cleanup ()
  "Cleanup all the tmp buffers created with `git-tmp-buf'."
  (interactive)
  (dolist (buf git-tmp-buf-list)
    (if (get-buffer buf)
	(kill-buffer buf)
      (message "%S does not exist" buf)))
  (setq git-tmp-buf-list nil))
