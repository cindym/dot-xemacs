;;; ppc-env.el --- Setup for PPC cross-compile
;; Copyright (C) 2007-2010 Sean MacLennan

(provide 'ppc-env)

(defvar ppc-toolchain-dir nil
  "*Base directory for toolchain.")

(defvar ppc-kernel-dir nil
  "*Base dir for kernel source")

(defvar ppc-u-boot-dir nil
  "*Base dir for u-boot. Optional.")

(defvar ppc-cross-compile "ppc_4xxFP-"
  "*Cross compile prefix.")

(defvar ppc-arch "powerpc"
  "*PPC arch value.")

(defvar ppc-env-list nil
  "*List of extra PPC env values to set")

(defvar ppc-saved-env nil
  "Internal list of original values.")

(defvar ppc-is-set nil
  "Local variable... do not touch!")

(add-minor-mode 'ppc-is-set " PPC")

(unless (fboundp 'my-expand-dir-name)
  (fset 'my-expand-dir-name 'expand-file-name))

;;;###autoload
(defun ppc-env ()
  (interactive)

  (unless ppc-toolchain-dir
    (error "ppc-toolchain-dir must be set"))
  (unless ppc-kernel-dir
    (error "ppc-kernel-dir must be set"))

  (if ppc-saved-env
      (ppc-restore)
    (ppc-set)))

;;;###autoload
(defun ppc-set-kernel-dir (&optional dir)
  (interactive)
  (when (interactive-p)
    (setq dir (read-directory-name "Dir: " ppc-kernel-dir))
    ;; Quick sanity check
    (unless (and (file-exists-p (concat dir "/kernel"))
		 (file-exists-p (concat dir "/mm")))
      (unless (y-or-n-p (concat dir " does not look like a kernel directory. "
				"Continue? "))
	(keyboard-quit))))
  (setq ppc-kernel-dir (my-expand-dir-name dir))
  (ppc-add-to-compile-dir-list ppc-kernel-dir)
  (when ppc-is-set
    ;; Don't use ppc-doit, we don't want to lose the orignal value
    (setenv "KERNELSRCDIR" ppc-kernel-dir)
    (setenv "KSRC" ppc-kernel-dir)))

;;;###autoload
(defun ppc-dump ()
  (interactive)
  (switch-to-buffer-other-window (get-buffer-create "*PPC ENV*"))
  (erase-buffer)

  (if ppc-is-set
      (insert "Currently in PPC mode.\n\n")
    (insert "Not in PPC mode.\n\n"))

  (insert "PPC Variables:\n")
  (insert (format "  %-20s %s\n" "ppc-toolchain-dir" (ppc-check-dir ppc-toolchain-dir)))
  (insert (format "  %-20s %s\n" "ppc-kernel-dir" (ppc-check-dir ppc-kernel-dir)))
  (insert (format "  %-20s %s\n" "ppc-u-boot-dir" (ppc-check-dir ppc-u-boot-dir)))
  (insert (format "  %-20s %s\n" "ppc-cross-compile" ppc-cross-compile))
  (insert (format "  %-20s %s\n" "ppc-arch" ppc-arch))

  (insert "\nEnvironment:\n")
  (dolist (env process-environment)
      (unless (string-match "^LS_COLORS=" env) ;; this one is evil
	(insert (format "  %s\n" env))))

  (goto-char (point-min)))

(defun ppc-check-dir (dir)
  (if (file-exists-p dir)
      (concat dir " (valid)")
    (concat dir " (BAD)")))

(defun ppc-set ()
  (ppc-doit "ARCH" ppc-arch)
  (ppc-doit "CROSS_COMPILE" ppc-cross-compile)
  (ppc-doit "CC" (concat ppc-cross-compile "gcc"))
  (ppc-doit "CXX" (concat ppc-cross-compile "g++"))
  (ppc-doit "AS" (concat ppc-cross-compile "as"))
  (ppc-doit "PATH" (concat (getenv "PATH") ":" ppc-toolchain-dir "/usr/bin"))
  (ppc-doit "KERNELSRCDIR" ppc-kernel-dir)
  ;; For Dahdi and others
  (ppc-doit "KSRC" ppc-kernel-dir)

  ;; Add this kernel to the compile dir list if necessary.
  ;; You can never have too many kernels ;)
  (ppc-add-to-compile-dir-list ppc-kernel-dir)
  (ppc-add-to-compile-dir-list ppc-u-boot-dir)

  ;; Add the user envs if necessary
  (dolist (env ppc-env-list)
    (ppc-doit (car env) (cadr env)))

  (setq ppc-is-set t))

(defun ppc-restore ()
  (dolist (env ppc-saved-env)
    (setenv (nth 0 env) (nth 1 env)))
  (setq ppc-saved-env nil)

  (setq ppc-is-set nil)
  )

(defun ppc-add-to-compile-dir-list (dir)
  (when (boundp 'my-compile-dir-list)
    (setq my-compile-dir-list
	  (add-to-list 'my-compile-dir-list
		       (list dir nil 'linux-style)))))

(defun ppc-doit (env val)
  "Save the old value and set the new value."
  (message "setenv '%s' from '%s' to '%s'" env (getenv env) val)
  (let ((tmp (list (list env (getenv env)))))
    (setq ppc-saved-env (nconc ppc-saved-env tmp)))
  (setenv env val)
  )
