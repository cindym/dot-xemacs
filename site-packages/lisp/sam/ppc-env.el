;;; ppc-env.el --- Setup for PPC cross-compile
;; Copyright (C) 2007 Sean MacLennan

;; Note: Some of this is very PIKA specific.

(provide 'ppc-env)

(defvar eldk-home "/usr/src/eldk"
  "*Base directory for ELDK.")

(defvar ppc-kernel-dir nil
  "*Base dir for kernel source")

(defvar ppc-cross-compile "ppc_4xxFP-"
  "*Cross compile prefix.")

(defvar ppc-saved-env nil
  "Internal list of original values.")

(defvar ppc-is-set nil)

(defvar ppc-arch "powerpc")

(add-minor-mode 'ppc-is-set " PPC")


;;;###autoload
(defun ppc-env ()
  (interactive)
  (if ppc-saved-env
      (ppc-restore)
    (ppc-set)))


(defun ppc-set ()
  (unless ppc-kernel-dir
    (setq ppc-kernel-dir (concat eldk-home "/ppc_4xxFP/usr/src/linux")))

  (doit "IPP" nil)
  (doit "PIKA_CFLAGS" "-DPIKA_DEVEL -fPIC")
  (doit "ARCH" ppc-arch)
  (doit "CROSS_COMPILE" ppc-cross-compile)
  (doit "CC" (concat ppc-cross-compile "gcc"))
  (doit "CXX" (concat ppc-cross-compile "g++"))
  (doit "AS" (concat ppc-cross-compile "as"))
  (doit "PATH" (concat (getenv "PATH") ":" eldk-home "/usr/bin"))
  (doit "KERNELSRCDIR" ppc-kernel-dir)

  ;; Add this kernel to the compile dir list if necessary.
  ;; You can never have too many kernels ;)
  (when (boundp 'my-compile-dir-list)
    (setq my-compile-dir-list
	  (add-to-list 'my-compile-dir-list
		       (list ppc-kernel-dir nil 'linux-style))))

  (setq ppc-is-set t)
  )

(defun ppc-restore ()
  (dolist (env ppc-saved-env)
    (setenv (nth 0 env) (nth 1 env)))
  (setq ppc-saved-env nil)

  (setq ppc-is-set nil)
  )

;; Save the old value and set the new value
(defun doit (env val)
  ;; (message "setenv '%s' from '%s' to '%s'" env (getenv env) val)
  (let ((tmp (list (list env (getenv env)))))
    (setq ppc-saved-env (nconc ppc-saved-env tmp)))
  (setenv env val)
  )
